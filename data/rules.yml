version: "3.1"

rules:

  # --- SALUDO: arrancar flujo pidiendo carnet ---
  - rule: flujo de saludo y pedir carnet
    steps:
      - intent: saludo
      - action: utter_pedir_carnet

  # --- Despedida sencilla ---
  - rule: responder despedida
    steps:
      - intent: despedida
      - action: utter_despedida

  # --- Agradecimientos ---
  - rule: responder agradecimientos
    steps:
      - intent: agradecimiento
      - action: utter_agradecimiento

  # --- Ayuda genérica ---
  - rule: responder ayuda
    steps:
      - intent: ayuda
      - action: utter_ayuda

  # --- Fuera de alcance ---
  - rule: manejar fuera de alcance
    steps:
      - intent: fuera_de_alcance
      - action: utter_fuera_de_alcance

  # --- Procesar carnet, verificar identidad e iniciar formulario si autenticado ---
  - rule: procesar carnet, autenticar e iniciar incidente
    steps:
      - intent: enviar_carnet
      - action: action_verificar_identidad
      - slot_was_set:
          - authenticated: true
      - action: incidente_form
      - active_loop: incidente_form

  # --- Al completar el formulario: usar RAG y preguntar si se solucionó ---
  - rule: sugerir solución con RAG al completar formulario
    condition:
      - active_loop: incidente_form
    steps:
      - action: incidente_form
      - active_loop: null
      - action: action_sugerir_solucion_incidente
      #- action: utter_preguntar_si_se_soluciono

  # --- Respuesta del usuario a "¿se solucionó?" ---

  - rule: usuario indica que el problema se solucionó
    steps:
      - action: utter_preguntar_si_se_soluciono
      - intent: afirmacion
      - action: action_end_conversation

  - rule: usuario indica que el problema NO se solucionó
    steps:
      - action: utter_preguntar_si_se_soluciono
      - intent: negacion
      - action: action_confirmar_reporte
      - action: utter_ofrecer_otro_incidente

  # --- Respuesta del usuario a "¿Deseas consultar o reportar otro problema?" ---

  - rule: usuario quiere reportar otro incidente
    steps:
      - action: utter_ofrecer_otro_incidente
      - intent: afirmacion
      - action: action_start_nuevo_incidente

  - rule: usuario no quiere reportar otro incidente
    steps:
      - action: utter_ofrecer_otro_incidente
      - intent: negacion
      - action: action_end_conversation


  - rule: Ver más pasos de solución desde KB
    steps:
    - intent: ver_mas_pasos
    - action: action_mostrar_mas_pasos_rag

  - rule: Levantar reporte directamente
    steps:
    - intent: levantar_reporte
    - action: action_confirmar_reporte
    - action: utter_ofrecer_otro_incidente

  - rule: Problema de categoria otros solucionado con LLM
    condition:
    - slot_was_set:
        - flujo_otros_llm: true
    steps:
    - intent: afirmacion
    - action: action_end_conversation
    
  - rule: Problema de categoria otros NO se solucionó con LLM
    condition:
    - slot_was_set:
        - flujo_otros_llm: true
    steps:
    - intent: negacion
    - action: action_confirmar_reporte
    - action: utter_ofrecer_otro_incidente

  - rule: cliente indica que el incidente se solucionó
    steps:
      - intent: incidente_solucionado
      - action: action_end_conversation
